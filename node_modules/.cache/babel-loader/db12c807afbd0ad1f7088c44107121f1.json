{"ast":null,"code":"var express = require('express');\n\nvar app = express();\n\nvar expressWs = require('express-ws')(app);\n\nvar os = require('os');\n\nvar pty = require('node-pty');\n\nvar terminals = {},\n    logs = {};\napp.use('/build', express.static(__dirname + '/../../../../build'));\napp.use('/demo', express.static(__dirname + '/../../../../demo'));\napp.use('/zmodemjs', express.static(__dirname + '/../../../../node_modules/zmodem.js/dist'));\napp.get('/', function (req, res) {\n  res.sendFile(__dirname + '/index.html');\n});\napp.get('/style.css', function (req, res) {\n  res.sendFile(__dirname + '/style.css');\n});\napp.get('/main.js', function (req, res) {\n  res.sendFile(__dirname + '/main.js');\n});\napp.post('/terminals', function (req, res) {\n  var cols = parseInt(req.query.cols),\n      rows = parseInt(req.query.rows),\n      term = pty.spawn(process.platform === 'win32' ? 'cmd.exe' : 'bash', [], {\n    encoding: null,\n    name: 'xterm-color',\n    cols: cols || 80,\n    rows: rows || 24,\n    cwd: process.env.PWD,\n    env: process.env\n  });\n  console.log('Created terminal with PID: ' + term.pid);\n  terminals[term.pid] = term;\n  logs[term.pid] = '';\n  term.on('data', function (data) {\n    logs[term.pid] += data;\n  });\n  res.send(term.pid.toString());\n  res.end();\n});\napp.post('/terminals/:pid/size', function (req, res) {\n  var pid = parseInt(req.params.pid),\n      cols = parseInt(req.query.cols),\n      rows = parseInt(req.query.rows),\n      term = terminals[pid];\n  term.resize(cols, rows);\n  console.log('Resized terminal ' + pid + ' to ' + cols + ' cols and ' + rows + ' rows.');\n  res.end();\n});\napp.ws('/terminals/:pid', function (ws, req) {\n  var term = terminals[parseInt(req.params.pid)];\n  console.log('Connected to terminal ' + term.pid);\n  ws.send(logs[term.pid]);\n  term.on('data', function (data) {\n    try {\n      ws.send(data);\n    } catch (ex) {// The WebSocket is not open, ignore\n    }\n  });\n  ws.on('message', function (msg) {\n    term.write(msg);\n  });\n  ws.on('close', function () {\n    term.kill();\n    console.log('Closed terminal ' + term.pid); // Clean things up\n\n    delete terminals[term.pid];\n    delete logs[term.pid];\n  });\n});\nvar port = process.env.PORT || 3000,\n    host = os.platform() === 'win32' ? '127.0.0.1' : '0.0.0.0';\nconsole.log('App listening to http://' + host + ':' + port);\napp.listen(port, host);","map":null,"metadata":{},"sourceType":"script"}